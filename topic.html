<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic - Eshimov Azizbek Forum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            arrayUnion, 
            arrayRemove,
            increment,
            setDoc,
            onSnapshot,
            collection,
            query,
            where,
            orderBy,
            limit,
            getDocs
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfQK0tvsnMUSG9ItP3t2Ejh1mnV1tStv4",
            authDomain: "eshimov-azizbek.firebaseapp.com",
            projectId: "eshimov-azizbek",
            storageBucket: "eshimov-azizbek.firebasestorage.app",
            messagingSenderId: "214963058663",
            appId: "1:214963058663:web:97dc951037ef2872622f42",
            measurementId: "G-DQ2CHSH3KF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebase = {
            db,
            doc,
            getDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            increment,
            setDoc,
            onSnapshot,
            collection,
            query,
            where,
            orderBy,
            limit,
            getDocs
        };
    </script>

    <link rel="stylesheet" href="./styles/topic.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container nav-container">
            <div class="logo">EA</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#skills">Skills</a></li>
                <li><a href="index.html#achievements">Achievements</a></li>
                <li><a href="index.html#contact">Contact</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="forum.html">Forum</a></li>
                <li class="user-menu" id="userMenu">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="dashboard.html" class="dropdown-item">My Dashboard</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Topic Content -->
    <div class="container topic-container">
        <!-- Sidebar -->
        <div class="topic-sidebar">
            <div class="user-profile-sidebar" id="authorProfile">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading author...</p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Related Topics</h3>
                <div class="related-topics-list" id="relatedTopicsList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading related topics...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Popular Topics</h3>
                <div class="popular-topics-list" id="popularTopicsList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading popular topics...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Forum Stats</h3>
                <div class="forum-stats" id="forumStats">
                    <div class="stat">
                        <div class="stat-value" id="topicsCount">0</div>
                        <div class="stat-label">Topics</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="commentsCount">0</div>
                        <div class="stat-label">Comments</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="usersCount">0</div>
                        <div class="stat-label">Users</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Forum Rules</h3>
                <ul style="font-size: 0.9rem; padding-left: 20px; color: #666;">
                    <li>Be respectful to other members</li>
                    <li>Stay on topic in discussions</li>
                    <li>No spam or self-promotion</li>
                    <li>Earn XP by participating</li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="topic-main">
            <!-- Topic Detail -->
            <div class="topic-card">
                <div class="loading" id="topicLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading topic...</p>
                </div>
                
                <div id="topicContent" style="display: none;">
                    <div class="topic-header">
                        <div class="topic-voting">
                            <button class="vote-btn up" id="topicUpvote">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <div class="vote-count" id="topicVotes">0</div>
                            <button class="vote-btn down" id="topicDownvote">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="topic-content">
                            <h1 class="topic-title" id="topicTitle">Topic Title</h1>
                            <div class="topic-meta">
                                <div class="topic-author">
                                    <div class="author-avatar" id="topicAuthorAvatar">A</div>
                                    <span id="topicAuthor">Author Name</span>
                                </div>
                                <div><i class="far fa-clock"></i> <span id="topicDate">Just now</span></div>
                                <div><i class="far fa-comment"></i> <span id="topicCommentsCount">0 comments</span></div>
                            </div>
                            <div class="topic-tags" id="topicTags">
                                <!-- Tags will be populated by JavaScript -->
                            </div>
                            <div class="topic-body" id="topicBody">
                                <!-- Topic content will be populated by JavaScript -->
                            </div>
                            <div class="topic-actions">
                                <button class="action-btn" id="shareTopicBtn">
                                    <i class="fas fa-share"></i> Share
                                </button>
                                <button class="action-btn" id="bookmarkTopicBtn">
                                    <i class="far fa-bookmark"></i> Bookmark
                                </button>
                                <button class="action-btn" id="followTopicBtn">
                                    <i class="far fa-bell"></i> Follow
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="error-message" id="topicError" style="display: none;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3>Topic Not Found</h3>
                    <p>The topic you're looking for doesn't exist or may have been removed.</p>
                    <a href="forum.html" class="btn" style="margin-top: 15px;">Back to Forum</a>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
                <div class="comments-header">
                    <h2 class="comments-count" id="commentsCount">0 Comments</h2>
                    <button class="btn" id="sortCommentsBtn">
                        <i class="fas fa-sort"></i> Sort by: Newest
                    </button>
                </div>

                <!-- Comment Form -->
                <div class="comment-form" id="commentForm">
                    <h3>Add a Comment</h3>
                    <textarea id="commentText" placeholder="Write your comment here..."></textarea>
                    <button class="btn" id="submitCommentBtn">Post Comment</button>
                </div>

                <!-- Comments List -->
                <div class="comments-list" id="commentsList">
                    <!-- Comments will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 Eshimov Azizbek. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        // Firebase will be available through window.firebase after the module loads
        // Wait for Firebase to be initialized
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebase) {
                        resolve(window.firebase);
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // DOM Elements
        const topicLoading = document.getElementById('topicLoading');
        const topicContent = document.getElementById('topicContent');
        const topicError = document.getElementById('topicError');
        const topicTitle = document.getElementById('topicTitle');
        const topicAuthor = document.getElementById('topicAuthor');
        const topicAuthorAvatar = document.getElementById('topicAuthorAvatar');
        const topicDate = document.getElementById('topicDate');
        const topicVotes = document.getElementById('topicVotes');
        const topicTags = document.getElementById('topicTags');
        const topicBody = document.getElementById('topicBody');
        const topicCommentsCount = document.getElementById('topicCommentsCount');
        const commentsCount = document.getElementById('commentsCount');
        const commentsList = document.getElementById('commentsList');
        const authorProfile = document.getElementById('authorProfile');
        const relatedTopicsList = document.getElementById('relatedTopicsList');
        const popularTopicsList = document.getElementById('popularTopicsList');
        const commentForm = document.getElementById('commentForm');
        const commentText = document.getElementById('commentText');
        const submitCommentBtn = document.getElementById('submitCommentBtn');
        const topicUpvote = document.getElementById('topicUpvote');
        const topicDownvote = document.getElementById('topicDownvote');
        const sortCommentsBtn = document.getElementById('sortCommentsBtn');
        const topicsCount = document.getElementById('topicsCount');
        const commentsTotalCount = document.getElementById('commentsCount');
        const usersCount = document.getElementById('usersCount');

        // Current topic data and Firebase reference
        let currentTopic = null;
        let currentTopicId = null;
        let firebaseUtils = null;
        let unsubscribeTopic = null;
        let unsubscribeComments = null;
        let currentUser = null;

        // Initialize Topic Page
        async function initTopicPage() {
            // Wait for Firebase to load
            firebaseUtils = await waitForFirebase();
            
            // Get current user
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            updateUserUI();
            
            // Get topic ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentTopicId = urlParams.get('id');
            
            if (!currentTopicId) {
                showError();
                return;
            }
            
            // Load all dynamic data
            await Promise.all([
                loadTopic(currentTopicId),
                loadForumStats(),
                loadPopularTopics(),
                loadAuthorProfile()
            ]);
            
            // Set up event listeners
            setupTopicEventListeners();
        }

        // Update user UI in navigation
        function updateUserUI() {
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (currentUser) {
                userAvatar.textContent = currentUser.fullName.charAt(0).toUpperCase();
                userName.textContent = currentUser.fullName.split(' ')[0];
            } else {
                userAvatar.textContent = 'U';
                userName.textContent = 'User';
            }
        }

        // Load topic by ID from Firebase
        async function loadTopic(topicId) {
            // Show loading state
            topicLoading.style.display = 'block';
            topicContent.style.display = 'none';
            topicError.style.display = 'none';
            
            try {
                const { db, doc, getDoc, onSnapshot } = firebaseUtils;
                const topicRef = doc(db, "topics", topicId);
                
                // Get topic data once
                const topicDoc = await getDoc(topicRef);
                
                if (!topicDoc.exists()) {
                    showError();
                    return;
                }
                
                currentTopic = topicDoc.data();
                currentTopic.id = topicId;
                
                // Set up real-time listener for topic updates
                unsubscribeTopic = onSnapshot(topicRef, (doc) => {
                    if (doc.exists()) {
                        currentTopic = doc.data();
                        currentTopic.id = topicId;
                        updateTopicContent();
                        
                        // Load related topics based on current topic category
                        loadRelatedTopics(currentTopic.category);
                    }
                });
                
                // Set up real-time listener for comments
                const commentsRef = doc(db, "comments", topicId);
                unsubscribeComments = onSnapshot(commentsRef, (doc) => {
                    if (doc.exists()) {
                        const commentsData = doc.data();
                        currentTopic.comments = commentsData.comments || [];
                        updateComments();
                    }
                });
                
                // Hide loading, show content
                topicLoading.style.display = 'none';
                topicContent.style.display = 'block';
                
                // Load related topics based on category
                loadRelatedTopics(currentTopic.category);
            } catch (error) {
                console.error("Error loading topic:", error);
                showError();
            }
        }

        // Load forum statistics
        async function loadForumStats() {
            try {
                const { db, collection, getDocs } = firebaseUtils;
                
                // Get topics count
                const topicsSnapshot = await getDocs(collection(db, "topics"));
                topicsCount.textContent = topicsSnapshot.size;
                
                // Get total comments count
                let totalComments = 0;
                const commentsSnapshot = await getDocs(collection(db, "comments"));
                commentsSnapshot.forEach(doc => {
                    const commentsData = doc.data();
                    totalComments += commentsData.comments ? commentsData.comments.length : 0;
                });
                commentsTotalCount.textContent = totalComments;
                
                // Get users count (from the users collection if it exists)
                // For now, we'll use a placeholder
                usersCount.textContent = Math.floor(topicsSnapshot.size * 1.5);
            } catch (error) {
                console.error("Error loading forum stats:", error);
            }
        }

        // Load popular topics (most voted)
        async function loadPopularTopics() {
            try {
                const { db, collection, query, orderBy, limit, getDocs } = firebaseUtils;
                
                const topicsQuery = query(
                    collection(db, "topics"),
                    orderBy("votes", "desc"),
                    limit(5)
                );
                
                const querySnapshot = await getDocs(topicsQuery);
                const popularTopics = [];
                
                querySnapshot.forEach((doc) => {
                    const topic = doc.data();
                    topic.id = doc.id;
                    popularTopics.push(topic);
                });
                
                updatePopularTopicsUI(popularTopics);
            } catch (error) {
                console.error("Error loading popular topics:", error);
                popularTopicsList.innerHTML = '<p style="color: #777; text-align: center;">Error loading popular topics</p>';
            }
        }

        // Load related topics based on category
        async function loadRelatedTopics(category) {
            try {
                const { db, collection, query, where, limit, getDocs } = firebaseUtils;
                
                const topicsQuery = query(
                    collection(db, "topics"),
                    where("category", "==", category),
                    limit(5)
                );
                
                const querySnapshot = await getDocs(topicsQuery);
                const relatedTopics = [];
                
                querySnapshot.forEach((doc) => {
                    // Don't include the current topic
                    if (doc.id !== currentTopicId) {
                        const topic = doc.data();
                        topic.id = doc.id;
                        relatedTopics.push(topic);
                    }
                });
                
                updateRelatedTopicsUI(relatedTopics);
            } catch (error) {
                console.error("Error loading related topics:", error);
                relatedTopicsList.innerHTML = '<p style="color: #777; text-align: center;">Error loading related topics</p>';
            }
        }

        // Load author profile
        async function loadAuthorProfile() {
            if (!currentTopic) return;
            
            try {
                const { db, doc, getDoc } = firebaseUtils;
                
                // Try to get author data from users collection
                const userRef = doc(db, "users", currentTopic.authorId || "default");
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    updateAuthorProfileUI(userData);
                } else {
                    // Fallback to topic author data
                    updateAuthorProfileUI({
                        fullName: currentTopic.author,
                        initials: currentTopic.authorInitials,
                        stats: currentTopic.authorStats || { topics: 0, comments: 0, exp: 0 }
                    });
                }
            } catch (error) {
                console.error("Error loading author profile:", error);
                // Fallback to topic author data
                updateAuthorProfileUI({
                    fullName: currentTopic.author,
                    initials: currentTopic.authorInitials,
                    stats: currentTopic.authorStats || { topics: 0, comments: 0, exp: 0 }
                });
            }
        }

        // Show error state
        function showError() {
            topicLoading.style.display = 'none';
            topicContent.style.display = 'none';
            topicError.style.display = 'block';
            
            // Clean up listeners
            if (unsubscribeTopic) unsubscribeTopic();
            if (unsubscribeComments) unsubscribeComments();
        }

        // Update topic content
        function updateTopicContent() {
            if (!currentTopic) return;
            
            topicTitle.textContent = currentTopic.title;
            topicAuthor.textContent = currentTopic.author;
            topicAuthorAvatar.textContent = currentTopic.authorInitials;
            topicDate.textContent = formatTimestamp(currentTopic.timestamp);
            topicVotes.textContent = currentTopic.votes || 0;
            topicBody.innerHTML = currentTopic.content;
            topicCommentsCount.textContent = `${currentTopic.comments ? currentTopic.comments.length : 0} comments`;
            commentsCount.textContent = `${currentTopic.comments ? currentTopic.comments.length : 0} Comments`;
            
            // Update tags
            topicTags.innerHTML = '';
            if (currentTopic.tags) {
                currentTopic.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    topicTags.appendChild(tagElement);
                });
            }
            
            // Update vote buttons based on current user's vote
            updateVoteButtons();
        }

        // Update author profile UI
        function updateAuthorProfileUI(userData) {
            authorProfile.innerHTML = `
                <div class="user-avatar-sidebar">${userData.initials || userData.fullName.charAt(0)}</div>
                <div class="user-name-sidebar">${userData.fullName}</div>
                <div class="user-title">Community Member</div>
                <div class="user-stats">
                    <div class="user-stat">
                        <div class="user-stat-value">${userData.stats?.topics || 0}</div>
                        <div class="user-stat-label">Topics</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${userData.stats?.comments || 0}</div>
                        <div class="user-stat-label">Comments</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${userData.stats?.exp || 0}</div>
                        <div class="user-stat-label">EXP</div>
                    </div>
                </div>
            `;
        }

        // Update related topics UI
        function updateRelatedTopicsUI(relatedTopics) {
            if (relatedTopics.length === 0) {
                relatedTopicsList.innerHTML = '<p style="color: #777; text-align: center;">No related topics found</p>';
                return;
            }
            
            relatedTopicsList.innerHTML = '';
            
            relatedTopics.forEach(topic => {
                const topicElement = document.createElement('div');
                topicElement.className = 'related-topic-item';
                
                topicElement.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 0.9rem;">${topic.title}</div>
                        <div style="font-size: 0.8rem; color: #777;">by ${topic.author}</div>
                        <div class="topic-stats">
                            <div class="topic-stat">
                                <i class="fas fa-chevron-up"></i> ${topic.votes || 0}
                            </div>
                            <div class="topic-stat">
                                <i class="far fa-comment"></i> ${topic.comments ? topic.comments.length : 0}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click event to navigate to topic
                topicElement.addEventListener('click', () => {
                    window.location.href = `topic.html?id=${topic.id}`;
                });
                
                relatedTopicsList.appendChild(topicElement);
            });
        }

        // Update popular topics UI
        function updatePopularTopicsUI(popularTopics) {
            if (popularTopics.length === 0) {
                popularTopicsList.innerHTML = '<p style="color: #777; text-align: center;">No popular topics found</p>';
                return;
            }
            
            popularTopicsList.innerHTML = '';
            
            popularTopics.forEach(topic => {
                const topicElement = document.createElement('div');
                topicElement.className = 'popular-topic-item';
                
                topicElement.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 0.9rem;">${topic.title}</div>
                        <div style="font-size: 0.8rem; color: #777;">by ${topic.author}</div>
                        <div class="topic-stats">
                            <div class="topic-stat">
                                <i class="fas fa-chevron-up"></i> ${topic.votes || 0}
                            </div>
                            <div class="topic-stat">
                                <i class="far fa-comment"></i> ${topic.comments ? topic.comments.length : 0}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click event to navigate to topic
                topicElement.addEventListener('click', () => {
                    window.location.href = `topic.html?id=${topic.id}`;
                });
                
                popularTopicsList.appendChild(topicElement);
            });
        }

        // Update vote buttons based on current user
        function updateVoteButtons() {
            if (!currentTopic) return;
            
            if (!currentUser) {
                topicUpvote.classList.remove('upvoted');
                topicDownvote.classList.remove('downvoted');
                return;
            }
            
            const userVote = currentTopic.userVotes ? currentTopic.userVotes[currentUser.id] : null;
            
            if (userVote === 'up') {
                topicUpvote.classList.add('upvoted');
                topicDownvote.classList.remove('downvoted');
            } else if (userVote === 'down') {
                topicDownvote.classList.add('downvoted');
                topicUpvote.classList.remove('upvoted');
            } else {
                topicUpvote.classList.remove('upvoted');
                topicDownvote.classList.remove('downvoted');
            }
        }

        // Update comments
        function updateComments() {
            if (!currentTopic || !currentTopic.comments) return;
            
            commentsList.innerHTML = '';
            
            if (currentTopic.comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align: center; color: #777; padding: 40px;">No comments yet. Be the first to comment!</p>';
                return;
            }
            
            // Sort comments by timestamp (newest first)
            const sortedComments = [...currentTopic.comments].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedComments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                commentElement.dataset.id = comment.id;
                
                commentElement.innerHTML = `
                    <div class="comment-voting">
                        <button class="vote-btn up ${getCommentVoteStatus(comment) === 'up' ? 'upvoted' : ''}" data-id="${comment.id}" data-type="up">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <div class="comment-vote-count">${comment.votes || 0}</div>
                        <button class="vote-btn down ${getCommentVoteStatus(comment) === 'down' ? 'downvoted' : ''}" data-id="${comment.id}" data-type="down">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="comment-content">
                        <div class="comment-meta">
                            <div class="comment-author">
                                <div class="author-avatar">${comment.authorInitials}</div>
                                <span>${comment.author}</span>
                            </div>
                            <div>${formatTimestamp(comment.timestamp)}</div>
                        </div>
                        <div class="comment-body">${comment.content}</div>
                        <div class="comment-actions">
                            <button class="action-btn reply-btn" data-id="${comment.id}">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </div>
                    </div>
                `;
                
                commentsList.appendChild(commentElement);
            });
            
            // Add event listeners to comment vote buttons
            document.querySelectorAll('.comment-voting .vote-btn').forEach(btn => {
                btn.addEventListener('click', handleCommentVote);
            });
            
            // Add event listeners to reply buttons
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', handleReply);
            });
        }

        // Get current user's vote status for a comment
        function getCommentVoteStatus(comment) {
            if (!currentUser || !comment.userVotes) return null;
            
            return comment.userVotes[currentUser.id] || null;
        }

        // Format timestamp to relative time
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            
            // If it's already a relative time string, return it
            if (typeof timestamp === 'string' && (timestamp.includes('ago') || timestamp.includes('Just'))) {
                return timestamp;
            }
            
            // If it's a Firestore timestamp
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }

        // Handle topic voting
        async function handleTopicVote(e) {
            if (!currentTopic) return;
            
            if (!currentUser) {
                alert('Please log in to vote');
                return;
            }
            
            const voteType = e.currentTarget.id === 'topicUpvote' ? 'up' : 'down';
            
            try {
                const { db, doc, updateDoc, increment } = firebaseUtils;
                const topicRef = doc(db, "topics", currentTopicId);
                
                // Get current vote status
                const currentVote = currentTopic.userVotes ? currentTopic.userVotes[currentUser.id] : null;
                
                // Prepare update data
                const updateData = {};
                const userVotesField = `userVotes.${currentUser.id}`;
                
                if (currentVote === voteType) {
                    // Remove vote if clicking the same button
                    updateData[userVotesField] = null;
                    updateData.votes = increment(voteType === 'up' ? -1 : 1);
                } else {
                    // Apply new vote
                    updateData[userVotesField] = voteType;
                    
                    if (currentVote === 'up' && voteType === 'down') {
                        // Changing from up to down: -2 votes
                        updateData.votes = increment(-2);
                    } else if (currentVote === 'down' && voteType === 'up') {
                        // Changing from down to up: +2 votes
                        updateData.votes = increment(2);
                    } else if (currentVote === null && voteType === 'up') {
                        // New upvote: +1 vote
                        updateData.votes = increment(1);
                    } else if (currentVote === null && voteType === 'down') {
                        // New downvote: -1 vote
                        updateData.votes = increment(-1);
                    }
                }
                
                await updateDoc(topicRef, updateData);
                
                // Award EXP to voter (in a real app, this would be saved)
                console.log(`Awarded 1 EXP to ${currentUser.fullName} for voting`);
            } catch (error) {
                console.error("Error updating vote:", error);
                alert('Error updating vote. Please try again.');
            }
        }

        // Handle comment voting
        async function handleCommentVote(e) {
            if (!currentTopic) return;
            
            e.stopPropagation();
            
            if (!currentUser) {
                alert('Please log in to vote');
                return;
            }
            
            const commentId = e.target.closest('.vote-btn').dataset.id;
            const voteType = e.target.closest('.vote-btn').dataset.type;
            
            try {
                const { db, doc, getDoc, updateDoc } = firebaseUtils;
                const commentsRef = doc(db, "comments", currentTopicId);
                
                // Get current comments
                const commentsDoc = await getDoc(commentsRef);
                if (!commentsDoc.exists()) return;
                
                const commentsData = commentsDoc.data();
                const comments = commentsData.comments || [];
                
                // Find the comment to update
                const commentIndex = comments.findIndex(c => c.id === commentId);
                if (commentIndex === -1) return;
                
                const comment = comments[commentIndex];
                
                // Initialize userVotes if not exists
                if (!comment.userVotes) comment.userVotes = {};
                
                // Get current vote status
                const currentVote = comment.userVotes[currentUser.id];
                
                // Update vote count and user vote
                if (currentVote === voteType) {
                    // Remove vote if clicking the same button
                    comment.userVotes[currentUser.id] = null;
                    comment.votes = (comment.votes || 0) + (voteType === 'up' ? -1 : 1);
                } else {
                    // Apply new vote
                    if (currentVote === 'up' && voteType === 'down') {
                        // Changing from up to down: -2 votes
                        comment.votes = (comment.votes || 0) - 2;
                    } else if (currentVote === 'down' && voteType === 'up') {
                        // Changing from down to up: +2 votes
                        comment.votes = (comment.votes || 0) + 2;
                    } else if (currentVote === null && voteType === 'up') {
                        // New upvote: +1 vote
                        comment.votes = (comment.votes || 0) + 1;
                    } else if (currentVote === null && voteType === 'down') {
                        // New downvote: -1 vote
                        comment.votes = (comment.votes || 0) - 1;
                    }
                    
                    comment.userVotes[currentUser.id] = voteType;
                }
                
                // Update the comment in the array
                comments[commentIndex] = comment;
                
                // Save back to Firestore
                await updateDoc(commentsRef, { comments });
                
                // Award EXP to voter (in a real app, this would be saved)
                console.log(`Awarded 1 EXP to ${currentUser.fullName} for voting`);
            } catch (error) {
                console.error("Error updating comment vote:", error);
                alert('Error updating vote. Please try again.');
            }
        }

        // Handle reply to comment
        function handleReply(e) {
            const commentId = e.currentTarget.dataset.id;
            const comment = currentTopic.comments.find(c => c.id === commentId);
            
            if (!comment) return;
            
            // Focus on comment textarea and add mention
            commentText.focus();
            commentText.value = `@${comment.author} `;
        }

        // Handle comment submission
        async function submitComment() {
            if (!currentTopic) return;
            
            if (!currentUser) {
                alert('Please log in to comment');
                return;
            }
            
            const content = commentText.value.trim();
            if (!content) {
                alert('Please enter a comment');
                return;
            }
            
            try {
                const { db, doc, updateDoc, arrayUnion, getDoc, setDoc } = firebaseUtils;
                const commentsRef = doc(db, "comments", currentTopicId);
                
                // Create new comment
                const newComment = {
                    id: Date.now().toString(), // Simple ID generation
                    author: currentUser.fullName,
                    authorInitials: currentUser.fullName.split(' ').map(n => n[0]).join(''),
                    content,
                    votes: 0,
                    userVotes: {},
                    timestamp: new Date()
                };
                
                // Check if comments document exists
                const commentsDoc = await getDoc(commentsRef);
                if (commentsDoc.exists()) {
                    // Update existing comments document
                    await updateDoc(commentsRef, {
                        comments: arrayUnion(newComment)
                    });
                } else {
                    // Create new comments document
                    await setDoc(commentsRef, {
                        comments: [newComment]
                    });
                }
                
                // Award EXP for commenting
                if (currentUser.exp === undefined) currentUser.exp = 0;
                currentUser.exp += 5;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Clear comment form
                commentText.value = '';
                
                // Show success message
                alert('Comment posted successfully! You earned 5 EXP.');
            } catch (error) {
                console.error("Error posting comment:", error);
                alert('Error posting comment. Please try again.');
            }
        }

        // Set up event listeners
        function setupTopicEventListeners() {
            // Topic voting
            topicUpvote.addEventListener('click', handleTopicVote);
            topicDownvote.addEventListener('click', handleTopicVote);
            
            // Comment submission
            submitCommentBtn.addEventListener('click', submitComment);
            
            // Sort comments button
            sortCommentsBtn.addEventListener('click', () => {
                if (!currentTopic) return;
                
                // Toggle between newest and oldest
                const currentSort = sortCommentsBtn.textContent.includes('Newest') ? 'newest' : 'oldest';
                
                if (currentSort === 'newest') {
                    // Sort by oldest first
                    currentTopic.comments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    sortCommentsBtn.innerHTML = '<i class="fas fa-sort"></i> Sort by: Oldest';
                } else {
                    // Sort by newest first (default)
                    currentTopic.comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortCommentsBtn.innerHTML = '<i class="fas fa-sort"></i> Sort by: Newest';
                }
                
                updateComments();
            });
            
            // Action buttons
            document.getElementById('shareTopicBtn').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: currentTopic.title,
                        text: currentTopic.content.substring(0, 100) + '...',
                        url: window.location.href
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    navigator.clipboard.writeText(window.location.href);
                    alert('Link copied to clipboard!');
                }
            });
            
            document.getElementById('bookmarkTopicBtn').addEventListener('click', function() {
                this.classList.toggle('active');
                this.innerHTML = this.classList.contains('active') ? 
                    '<i class="fas fa-bookmark"></i> Bookmarked' : 
                    '<i class="far fa-bookmark"></i> Bookmark';
                
                alert(this.classList.contains('active') ? 
                    'Topic bookmarked!' : 
                    'Topic removed from bookmarks');
            });
            
            document.getElementById('followTopicBtn').addEventListener('click', function() {
                this.classList.toggle('active');
                this.innerHTML = this.classList.contains('active') ? 
                    '<i class="fas fa-bell"></i> Following' : 
                    '<i class="far fa-bell"></i> Follow';
                
                alert(this.classList.contains('active') ? 
                    'You are now following this topic!' : 
                    'You are no longer following this topic');
            });
            
            // User menu dropdown
            const userMenu = document.getElementById('userMenu');
            const dropdownMenu = document.getElementById('dropdownMenu');
            
            if (userMenu) {
                userMenu.addEventListener('click', () => {
                    dropdownMenu.classList.toggle('show');
                });
                
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm('Are you sure you want to log out?')) {
                        localStorage.removeItem('currentUser');
                        window.location.href = 'index.html';
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userMenu.contains(e.target)) {
                        dropdownMenu.classList.remove('show');
                    }
                });
            }
        }

        // Initialize the topic page when the page loads
        document.addEventListener('DOMContentLoaded', initTopicPage);
    </script>
</body>
</html>